name: release-precompiled

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runs_on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            runs_on: ubuntu-latest
            target: x86_64-linux-gnu
          - name: macos-arm64
            runs_on: macos-15
            target: aarch64-apple-darwin

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up BEAM (Elixir/Erlang)
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.19'
          otp-version: '28.0'

      - name: Cache Homebrew downloads (macOS)
        if: runner.os == 'macOS'
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
          key: homebrew-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            homebrew-${{ runner.os }}-

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            clang \
            cmake \
            pkg-config \
            python3 \
            scons \
            libvulkan-dev \
            vulkan-tools \
            git \
            zip \
            unzip

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          # Vulkan on macOS is provided via MoltenVK.
          # Keep this list conservative to avoid CI breakage from formula changes.
          brew install cmake scons molten-vk vulkan-headers vulkan-loader shaderc

      - name: Build libgodot
        run: |
          ./build_libgodot.sh --release

      - name: Configure NIF build
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build NIF (single job)
        run: |
          cmake --build build --target libgodot_nif

      - name: Normalize and verify libgodot install name (macOS)
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail
          # Ensure the packaged dylib does not keep Godot's original install name (bin/libgodot...).
          install_name_tool -id "@rpath/libgodot.dylib" "priv/libgodot.dylib"
          otool -D "priv/libgodot.dylib" | tail -n 1 | grep -F "@rpath/libgodot.dylib"

      - name: Package artefact
        run: |
          set -euo pipefail
          # Draft releases are created per-commit on main.
          VERSION="${GITHUB_SHA::7}"

          mkdir -p dist

          # Determine platform libgodot filename.
          if [ "${{ runner.os }}" = "macOS" ]; then
            LIBGODOT_NAME="libgodot.dylib"
          else
            LIBGODOT_NAME="libgodot.so"
          fi

          test -f "priv/libgodot_nif.so"
          test -f "priv/${LIBGODOT_NAME}"

          TAR_NAME="libgodot-nif-${{ matrix.target }}-${VERSION}.tar.gz"

          # Package only the runtime bits needed in priv/.
          tar -czf "dist/${TAR_NAME}" -C priv "libgodot_nif.so" "${LIBGODOT_NAME}"

          echo "Built dist/${TAR_NAME}"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: true
          tag_name: "main-${{ github.sha }}"
          name: "main-${{ github.sha }}"
          target_commitish: "${{ github.sha }}"
          files: |
            dist/*.tar.gz
